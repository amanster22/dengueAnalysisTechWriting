---
title: "dengueAnalysis"
author: "Aman Shaik, Nick Huberty, Tom Suo, Connor Lee"
date: "2025-10-07"
output: html_document
---

### Our group was initially interested in exploring Public Health-related datasets due to our desire of exploring geospatial details of disease and how that affects different geographies. COVID-19 was a huge influence to us wanting to experiment with another form of health concern. This specific dataset includes cases of the Dengue Fever in the city of Merida, from 2012 to 2015, and outlines the coordinates of where every case specifically took place. Through our analysis, we plan on visualizing how the Dengue Fever has spread across Merida over a four-year period, and how it can help inform how diseases typically spread in urban environments.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data_loading}
library(ggplot2)
library(dplyr)
library(tidyverse)
data <- read.csv('Merida_Den12_13_14_15.csv')
head(data)
```

```{r summary}
summary(data)
```

```{r}
# This plot shows the number of Dengue Fever cases in the city of Merida from 2012 to 2015, while also highlighting the Year-over-Year percent change of Dengue Fever cases from the previous year. Dengue Fever clearly has the highest amount of cases in 2012, however, sees a ~50% drop in cases in the following 2013 year. The number of cases still drops going into 2014, however, the number of cases spikes up by almost 200% from 2014 to 2015. This drastic increase in Dengue Fever cases in 2015 can lead us to believe that some sort of environmental or external effect led to cases going up to nearly 75,000. We could also hypothesize that outbreaks typically last around three years, before another outbreak starts.

data_formatted <- data %>%
  pivot_longer(
    cols = starts_with("Den"),
    names_to = "Year",
    values_to = "Count"
  ) %>%
  mutate(Year = as.numeric(gsub("Den", "", Year)))

data_summary <- data_formatted %>%
  group_by(Year) %>%
  summarise(
    total_dengue = sum(Count, na.rm = TRUE))%>%
  arrange(Year) %>%
  mutate(
    percent_change = (total_dengue - lag(total_dengue))/lag(total_dengue) * 100
  )

ggplot(data_summary, aes(x = Year)) +
  geom_line(aes(y = percent_change * 100), color = "red", size = 1.2) +
  scale_y_continuous(
    name = "Total Dengue Cases",
    sec.axis = sec_axis(~./100, name = "% Change from Previous Year")
  ) +
  geom_col(aes(y=total_dengue), fill = "blue")+
  theme_minimal(base_size = 12) +
  labs(
    title = "Total Dengue Cases and Year-over-Year % Change in Merida",
    x = "Year"
  )
```

```{r mapping_plot} 
#maybe overlay the map of the location
# This plot shows the geospatial location of dengue incidence in Merida, Mexico. We can potentially aesthetically improve this plot later using QGIS or ArcGIS.
plot(data$X, data$Y, 
     main = "Spatial Locations of Sampling Points",
     xlab = "X Coordinate", 
     ylab = "Y Coordinate", 
     pch = 19, col = "blue")
library(ggplot2)
# 1️ Read file
library(sf)

town_map <- st_read("C:/Users/pompo/OneDrive/Documents/GitHub/dengueAnalysisTechWriting/Merida_S25/Merida_Den12_13_14_15")
st_crs(town_map)
disease_data <- read.csv('Merida_Den12_13_14_15.csv')

# make sure CRS is same, convert to sf
disease_sf <- st_as_sf(disease_data, coords = c("X", "Y"), crs = st_crs(town_map))
names(disease_data)

# 4 generate plot
ggplot() +
  geom_sf(data = town_map, fill = "gray95", color = "black", linewidth = 0.3) +
  geom_sf(data = disease_sf, aes(color = Den2012, size = Den2012)) +
  scale_color_viridis_c(option = "plasma") +
  theme_minimal() +
  labs(title = "Spatial Locations",
       color = "Incidence",
       size = "Incidence")

```

```{r mapping_ggplot}
# This plot shows the density of dengue, indicating more vulnerable areas in the city. 

ggplot(data, aes(x = X, y = Y, color = Den2012)) +
  geom_point(size = 3) +
  scale_color_viridis_c(option = "plasma") +
  labs(title = "Dengue Fever Density (2012)",
       x = "X Coordinate", y = "Y Coordinate",
       color = "Density") +
  theme_minimal()

```


This interactive plot visualizes the density and geographic spread of Dengue Fever cases in Merida, Mexico, from 2012 to 2015. The animation reveals a dynamic pattern: the outbreaks in 2012 and 2013 were diversely concentrated across the city. From 2014 onwards, there were far fewer hotspots. However, while the 2015 outbreak appears less widespread, the data indicates a significant spike in total cases from the previous year, suggesting that the remaining hotspots became much more intense.
```{r mapping_ggplot}
library(plotly)
library(tidyr)
library(dplyr)

data <- read.csv('Merida_Den12_13_14_15.csv')

data_long <- data %>%
  pivot_longer(
    cols = starts_with("Den"),
    names_to = "Year",
    names_prefix = "Den",
    values_to = "Cases"
  ) %>%
  mutate(Year = as.integer(Year))

fig <- plot_ly(
  data_long,
  x = ~X,
  y = ~Y,
  frame = ~Year,
  type = 'scatter',
  mode = 'markers',
  marker = list(
    size = 10,
    color = ~Cases,  # color corresponds directly to number of cases
    colorscale = list(
      list(0, "lightgrey"),
      list(1, "red")
    ),
    showscale = TRUE,
    colorbar = list(title = "Case Count"),
    line = list(width = 0)  # removes border around points for cleaner look
  ),
  # Include coordinates + year + case count in hover
  text = ~paste(
    "Year:", Year,
    #"<br>Cases:", Cases,
    "<br>X:", round(X, 2),
    "<br>Y:", round(Y, 2)
  ),
  hoverinfo = 'text'
)

fig <- fig %>%
  layout(
    title = 'Dengue Fever Density in Merida (2012–2015)',
    xaxis = list(title = 'X Coordinate'),
    yaxis = list(title = 'Y Coordinate'),
    plot_bgcolor = "#f0f0f0",
    paper_bgcolor = "#f0f0f0"
  ) %>%
  animation_opts(
    frame = 1500,
    transition = 500,
    easing = "linear"
  ) %>%
  animation_slider(
    currentvalue = list(
      prefix = "Year: ",
      font = list(color = "red")
    )
  )

fig

```

```{r YOY analysis}
library(dplyr)
library(sf)
library(leaflet)
library(htmltools)
library(scales)

# 1. Calculate Year-over-Year (YoY) percentage change
# We must handle cases where the denominator (previous year) is 0.
calculate_yoy <- function(current, previous) {
  case_when(
    previous == 0 & current == 0 ~ 0,  # 0 to 0 is 0% change
    previous == 0 & current > 0 ~ Inf, # 0 to N is infinite % change
    previous > 0 ~ (current - previous) / previous
  )
}

data_yoy <- data %>%
  mutate(
    YoY_2013 = calculate_yoy(Den2013, Den2012),
    YoY_2014 = calculate_yoy(Den2014, Den2013),
    YoY_2015 = calculate_yoy(Den2015, Den2014)
  )

# 2. Clean up Inf/-Inf/NaN values for visualization. We'll set Inf to NA.
data_yoy <- data_yoy %>%
  mutate(across(starts_with("YoY_"), ~if_else(is.finite(.), ., NA_real_)))

# 3. Convert to a geospatial 'sf' object and transform coordinates
# The .prj file (EPSG:6371) tells us this is Mexico ITRF2008 / UTM zone 16N.
# Leaflet requires standard WGS84 (EPSG:4326) coordinates (lat/lon).
data_sf <- st_as_sf(data_yoy, coords = c("X", "Y"), crs = 6371)
data_sf_wgs84 <- st_transform(data_sf, crs = 4326)

# 4. Define a diverging color palette
# We cap the domain from -1 (-100%) to 2 (200%) to handle outliers
cap_range <- c(-1, 2)
pal_yoy <- colorNumeric(
  palette = "RdYlBu", 
  domain = cap_range, 
  na.color = "#a0a0a0",
  reverse = TRUE # Make red positive (increase), blue negative (decrease)
)

# 5. Create formatted popup and label content
# Popups appear on click
popup_2013 <- ~lapply(sprintf(
  "<strong>Location ID: %s</strong><br/>2012 Cases: %d<br/>2013 Cases: %d<br/>YoY Change: %s",
  SP_ID, Den2012, Den2013, scales::percent(YoY_2013, accuracy = 0.1)
), HTML)

popup_2014 <- ~lapply(sprintf(
  "<strong>Location ID: %s</strong><br/>2013 Cases: %d<br/>2014 Cases: %d<br/>YoY Change: %s",
  SP_ID, Den2013, Den2014, scales::percent(YoY_2014, accuracy = 0.1)
), HTML)

popup_2015 <- ~lapply(sprintf(
  "<strong>Location ID: %s</strong><br/>2014 Cases: %d<br/>2015 Cases: %d<br/>YoY Change: %s",
  SP_ID, Den2014, Den2015, scales::percent(YoY_2015, accuracy = 0.1)
), HTML)

# Labels appear on hover
label_2013 <- ~scales::percent(YoY_2013, accuracy = 0.1)
label_2014 <- ~scales::percent(YoY_2014, accuracy = 0.1)
label_2015 <- ~scales::percent(YoY_2015, accuracy = 0.1)
```

```{r interactive_map}
# Create the interactive leaflet map
m <- leaflet(data_sf_wgs84) %>%
  # Add base map layers
  addProviderTiles(providers$CartoDB.Positron, group = "Light Map") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Satellite") %>%
  
  # Set the map to focus on the data
  fitBounds(
    ~as.numeric(st_bbox(geometry)[1]),
    ~as.numeric(st_bbox(geometry)[2]),
    ~as.numeric(st_bbox(geometry)[3]),
    ~as.numeric(st_bbox(geometry)[4])
  ) %>%

  # ==== Layer 1: 2013 vs 2012 ====
  addCircleMarkers(
    group = "2013 vs 2012",
    color = ~pal_yoy(YoY_2013),
    fillOpacity = 0.8,
    stroke = FALSE,
    radius = 5,
    popup = popup_2013,
    label = label_2013
  ) %>%
  
  # ==== Layer 2: 2014 vs 2013 ====
  addCircleMarkers(
    group = "2014 vs 2013",
    color = ~pal_yoy(YoY_2014),
    fillOpacity = 0.8,
    stroke = FALSE,
    radius = 5,
    popup = popup_2014,
    label = label_2014
  ) %>%

  # ==== Layer 3: 2015 vs 2014 ====
  addCircleMarkers(
    group = "2015 vs 2014",
    color = ~pal_yoy(YoY_2015),
    fillOpacity = 0.8,
    stroke = FALSE,
    radius = 5,
    popup = popup_2015,
    label = label_2015
  ) %>%
  
  # ==== Legend ====
  addLegend(
    pal = pal_yoy,
    values = cap_range,
    title = "YoY % Change",
    position = "bottomright",
    labFormat = labelFormat(suffix = "%", transform = function(x) x * 100),
    opacity = 1
  ) %>%

  # ==== Layer Control ====
  # This provides radio buttons to select one year-period at a time,
  # fulfilling the "slider" request to select a year.
  addLayersControl(
    baseGroups = c("2013 vs 2012", "2014 vs 2013", "2015 vs 2014"),
    overlayGroups = c("Light Map", "Satellite"),
    options = layersControlOptions(collapsed = FALSE)
  )

# Display the map
m
```


